# 更新日誌 (Changelog)

## [2.0.0] - 2026-01-XX

### 🎉 重大更新

本次更新對後端架構進行了全面升級，新增多個核心功能模塊，大幅提升系統性能、可維護性和用戶體驗。

---

### ✨ 新增功能

#### 1. **API 日誌統計系統** (`app/logs/`)
- ✅ 完整的 API 調用統計和分析功能
- ✅ 關鍵詞使用頻率追蹤（locations、regions 等參數）
- ✅ 自動化數據聚合（每小時執行）
- ✅ 定時清理舊日誌（每週日凌晨 3:00）
- ✅ 管理員後台管理接口
- ✅ 批量寫入優化（50條/批）
- ✅ SQLite WAL 模式 + 64MB 緩存優化
- 📊 提供 8 個統計 API 端點：
  - `/api/logs/keyword/top` - Top 關鍵詞統計
  - `/api/logs/api/usage` - API 調用統計
  - `/api/logs/keyword/search` - 關鍵詞搜索
  - `/api/logs/stats/summary` - 統計概覽
  - `/api/logs/stats/fields` - 字段分布統計
  - `/api/logs/cleanup` - 清理舊日誌（管理員）
  - `/api/logs/aggregate` - 手動觸發聚合（管理員）
  - `/api/logs/database/size` - 數據庫大小監控（管理員）

#### 2. **Redis 緩存系統** (`app/redis_client.py`)
- ✅ Redis 連接池管理
- ✅ 自動重連機制
- ✅ 優雅關閉連接
- 🚀 提升高頻查詢性能

#### 3. **數據庫連接池** (`app/sql/db_pool.py`)
- ✅ 多數據庫連接池管理
- ✅ 自動連接復用
- ✅ 連接健康檢查
- ✅ 優雅關閉所有連接池
- 🚀 減少數據庫連接開銷，提升並發性能

#### 4. **工具模塊** (`app/tools/`)
提供三個實用的語言學工具 Web 界面：

##### 4.1 **Check 工具** (`/api/tools/check`)
- 檢查方言數據完整性
- 驗證音韻數據格式
- 批量數據校驗

##### 4.2 **Jyut2IPA 工具** (`/api/tools/jyut2ipa`)
- 粵拼轉 IPA 音標
- 支持批量轉換
- 提供詳細的音韻標註

##### 4.3 **Merge 工具** (`/api/tools/merge`)
- 合併多個方言數據文件
- 智能去重和衝突處理
- 支持多種文件格式（Excel、CSV 等）

##### 4.4 **文件管理器** (`file_manager.py`)
- 臨時文件自動管理
- 定期清理過期文件（12小時）
- 任務目錄隔離

##### 4.5 **任務管理器** (`task_manager.py`)
- 後台任務調度
- 任務狀態追蹤
- 異步任務執行

#### 5. **SQL 管理模塊** (`app/sql/`)
- ✅ 數據庫選擇器 (`choose_db.py`)
- ✅ 索引管理器 (`index_manager.py`) - 自動優化查詢索引
- ✅ SQL 查詢接口 (`sql_routes.py`)
- ✅ 樹狀結構查詢 (`sql_tree_routes.py`)
- 📊 提供靈活的數據庫管理和查詢功能

#### 6. **管理員系統** (`app/routes/admin.py`, `app/schemas/admin.py`)
- ✅ 管理員權限控制
- ✅ 用戶管理接口
- ✅ 系統配置管理
- ✅ 日誌查看和管理

#### 7. **用戶系統增強** (`app/routes/user.py`, `app/schemas/user.py`)
- ✅ 用戶活動追蹤
- ✅ 用戶偏好設置
- ✅ 用戶數據統計
- ✅ 後台隊列寫入優化

#### 8. **新音韻查詢系統** (`app/routes/new_pho.py`, `app/service/new_pho.py`)
- ✅ 增強的音韻查詢功能
- ✅ 音韻分類矩陣 (`phonology_classification_matrix.py`)
- ✅ 聲調搜索功能 (`search_tones.py`)
- 🚀 更精確的音韻數據檢索

#### 9. **定時任務調度器** (`app/logs/scheduler.py`)
- ✅ 基於 APScheduler 的任務調度
- ✅ 自動清理舊日誌（每週日 03:00）
- ✅ 自動聚合統計（每小時第 5 分鐘）
- ✅ 優雅啟動和停止

#### 10. **格式轉換工具** (`app/tools/format_convert.py`)
- ✅ 支持多種文件格式互轉
- ✅ Excel、CSV、JSON 等格式支持
- ✅ 批量轉換功能

---

### 🚀 性能優化

#### 1. **GZip 壓縮中間件**
- 自動壓縮大於 1KB 的響應
- 減少網絡傳輸量
- 提升前端加載速度

#### 2. **數據庫優化**
- SQLite WAL 模式
- 64MB 緩存配置
- 自動索引管理
- 連接池復用

#### 3. **批量寫入優化**
- API 日誌批量寫入（50條/批）
- 用戶活動隊列寫入
- 減少數據庫 I/O 壓力

#### 4. **Redis 緩存**
- 高頻查詢結果緩存
- 會話數據緩存
- 減少數據庫查詢次數

---

### 🔧 架構改進

#### 1. **模塊化路由管理**
- 統一的路由註冊機制
- 清晰的模塊劃分
- 易於擴展和維護

#### 2. **中間件系統**
- CORS 跨域支持
- GZip 壓縮
- 流量日誌記錄
- 請求統計

#### 3. **生命週期管理**
- 優雅啟動（連接池初始化、索引優化）
- 優雅關閉（連接池關閉、線程停止）
- 資源自動清理

#### 4. **多運行模式支持**
- EXE 模式（打包為可執行文件）
- MINE 模式（開發模式）
- 生產模式（gunicorn 多進程）

---

### 📝 文檔完善

#### 1. **API 使用文檔**
- 新增 `app/logs/API_USAGE.md` - 日誌系統完整使用文檔
- 包含所有 API 端點說明
- 提供詳細的請求/響應示例
- 性能優化建議

#### 2. **項目結構文檔**
- 更新 README.md
- 詳細的功能模塊說明
- 安裝和部署指南

---

### 🐛 Bug 修復

- 修復 gunicorn 多進程環境下的後台線程重複啟動問題
- 修復數據庫連接未正確關閉的問題
- 修復臨時文件未清理的問題
- 優化錯誤處理和日誌輸出

---

### 🔐 安全性增強

- 管理員權限驗證
- JWT Token 認證
- 密碼加密存儲（bcrypt）
- SQL 注入防護

---

### 📦 依賴更新

新增依賴：
- `redis~=7.1.0` - Redis 客戶端
- `APScheduler~=3.11.2` - 定時任務調度
- `python-docx==1.2.0` - Word 文檔處理
- `bcrypt==3.2.0` - 密碼加密
- `gunicorn==21.2.0` - 生產環境 WSGI 服務器

---

### 📊 數據統計

本次更新：
- 新增文件：50+ 個
- 修改文件：30+ 個
- 新增代碼行數：5000+ 行
- 新增 API 端點：20+ 個

---

## [1.0.0] - 2025-09-13

### 初始版本

#### 核心功能
- 基於 FastAPI 的後端框架
- 按中古地位整理漢字讀音
- 查詢某音位的中古來源
- 查字、查調功能
- 獲取地理坐標
- 用戶登錄系統
- 自定義數據添加和查詢

#### 基礎模塊
- `app/auth/` - 用戶認證模塊
- `app/custom/` - 自定義數據模塊
- `app/routes/` - 路由模塊
- `app/schemas/` - 數據模型
- `app/service/` - 業務邏輯層
- `common/` - 通用工具類

---

## 版本說明

- **主版本號（Major）**：重大架構變更或不兼容的 API 修改
- **次版本號（Minor）**：新增功能，向下兼容
- **修訂號（Patch）**：Bug 修復和小改進

---

## 未來計劃

### v2.1.0（計劃中）
- [ ] WebSocket 實時通知
- [ ] 更多數據可視化功能
- [ ] 批量導入/導出優化
- [ ] 多語言支持（i18n）
- [ ] API 限流和防護

### v2.2.0（計劃中）
- [ ] 機器學習音韻預測
- [ ] 地圖可視化增強
- [ ] 移動端 API 優化
- [ ] 數據版本控制

---

**開發者：不羈**
**最後更新：2026-01-XX**
